<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<title>Cabo Score Tracker</title>

<style>
  body { font-family: sans-serif; padding: 20px; max-width: 700px; margin: auto; }
  h1 { text-align: center; }
  .player { margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
  input[type="number"] { width: 60px; margin-left: 5px; }
  button, select { margin-left: 5px; padding: 5px 10px; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
  .total { font-weight: bold; background: #f0f0f0; }
  input[readonly], select:disabled { background: #eee; }
</style>
</head>

<body>

<h1>Cabo Score Tracker üÉè</h1>

<div>
  <strong>Game:</strong>
  <select id="gameSelect" onchange="loadSelectedGame()"></select>
  <button onclick="newGame()">New Game</button>
  <button onclick="saveGame()">üíæ Save</button>
</div>

<div style="margin-top:10px;">
  <strong>Cabo Claim:</strong>
  Correct
  <input type="number" id="correctPenalty" value="-5">
  Incorrect
  <input type="number" id="incorrectPenalty" value="15">
</div>

<hr>

<div>
  <input id="newPlayerName" placeholder="Enter player name">
  <button onclick="addPlayer()">Add Player</button>
</div>

<div id="players"></div>

<h3>Round: <span id="round">0</span></h3>


<table id="scoreTable">
  <thead>
    <tr><th>Round</th></tr>
  </thead>
  <tbody></tbody>
</table>

<div id="roundButton">
  <button onclick="addRound()">Add / Complete Round</button>
</div>
  
<script>
/* ---------- GLOBAL STORE ---------- */
let store = JSON.parse(localStorage.getItem("scoreTrackerStore")) || {
  games: {},
  currentGameId: null,
  nextGameNumber: 1
};

let players = [];
let round = 0;
let rounds = [];
let currentGameId = null;
let correctPenalty = -5;
let incorrectPenalty = 15;

/* ---------- GAME MANAGEMENT ---------- */
function newGame() {
  const id = `game-${store.nextGameNumber++}`;
  store.games[id] = {
    players: [],
    round: 0,
    rounds: [],
    correctPenalty: -5,
    incorrectPenalty: 15
  };
  store.currentGameId = id;
  persistStore();
  loadGame(id);
}

function loadGame(id) {
  const game = store.games[id];
  if (!game) return;

  currentGameId = id;
  players = JSON.parse(JSON.stringify(game.players));
  round = game.round;
  rounds = JSON.parse(JSON.stringify(game.rounds));
  correctPenalty = game.correctPenalty ?? -5;
  incorrectPenalty = game.incorrectPenalty ?? 15;

  document.getElementById("correctPenalty").value = correctPenalty;
  document.getElementById("incorrectPenalty").value = incorrectPenalty;

  lockPenaltyInputs(round > 0);

  document.getElementById("round").textContent = round;
  renderPlayers();
  renderTableHeader();
  rebuildTable();
  refreshGameSelect();
}

function loadSelectedGame() {
  const id = document.getElementById("gameSelect").value;
  store.currentGameId = id;
  persistStore();
  loadGame(id);
}

function saveGame() {
  if (!currentGameId) return;

  store.games[currentGameId] = {
    players,
    round,
    rounds,
    correctPenalty,
    incorrectPenalty
  };
  persistStore();
}

function persistStore() {
  localStorage.setItem("scoreTrackerStore", JSON.stringify(store));
}

/* ---------- UI ---------- */
function refreshGameSelect() {
  const select = document.getElementById("gameSelect");
  select.innerHTML = "";
  Object.keys(store.games).forEach(id => {
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = id;
    if (id === currentGameId) opt.selected = true;
    select.appendChild(opt);
  });
}

function lockPenaltyInputs(lock) {
  document.getElementById("correctPenalty").disabled = lock;
  document.getElementById("incorrectPenalty").disabled = lock;
}

/* ---------- PLAYERS ---------- */
function addPlayer() {
  const input = document.getElementById("newPlayerName");
  if (!input.value.trim()) return;
  players.push({ name: input.value.trim(), total: 0 });
  input.value = "";
  renderPlayers();
  renderTableHeader();
  saveGame();
}

function renderPlayers() {
  const div = document.getElementById("players");
  div.innerHTML = "";
  players.forEach((p, i) => {
    div.innerHTML += `
      <div class="player">
        <span>${p.name} - Total: ${p.total}</span>
        <button onclick="removePlayer(${i})">Remove</button>
      </div>`;
  });
}

function removePlayer(index) {
  players.splice(index, 1);
  renderPlayers();
  renderTableHeader();
  rebuildTable();
  saveGame();
}

/* ---------- TABLE HEADER ---------- */
function renderTableHeader() {
  const tr = document.querySelector("#scoreTable thead tr");
  tr.innerHTML = "<th>Round</th>";
  players.forEach(p => tr.innerHTML += `<th>${p.name}</th>`);
  tr.innerHTML += "<th>Cabo</th><th>Total After Round</th>";
}

/* ---------- ROUNDS ---------- */
function addRound() {
  if (players.length === 0) return alert("Add players first");

  // lock penalties once first round begins
  correctPenalty = parseInt(document.getElementById("correctPenalty").value, 10);
  incorrectPenalty = parseInt(document.getElementById("incorrectPenalty").value, 10);
  lockPenaltyInputs(true);

  // Complete previous round
  if (round > 0 && rounds[round - 1] && !rounds[round - 1].completed) {
    const r = rounds[round - 1];

    for (let i = 0; i < players.length; i++) {
      const input = document.getElementById(`score-${round}-${i}`);
      if (!input || input.value === "") return alert("Enter all scores");
      r.scores[i] = parseInt(input.value, 10);
      input.readOnly = true;
    }

    const CaboSelect = document.getElementById(`Cabo-${round}`);
    if (!CaboSelect || CaboSelect.value === "") return alert("Select Cabo");
    r.CaboIndex = parseInt(CaboSelect.value);
    CaboSelect.disabled = true;

    const min = Math.min(...r.scores);
    const count = r.scores.filter(s => s === min).length;

    if (r.scores[r.CaboIndex] === min && count === 1)
      r.scores[r.CaboIndex] += correctPenalty;
    else if (count === 1)
      r.scores[r.CaboIndex] += incorrectPenalty;

    players.forEach((p, i) => p.total += r.scores[i]);
    document.getElementById(`round-total-${round}`).textContent =
      players.map(p => p.total).join(", ");

    r.completed = true;
  }

  // New round
  round++;
  rounds.push({
    scores: Array(players.length).fill(null),
    CaboIndex: null,
    completed: false
  });

  document.getElementById("round").textContent = round;

  const tbody = document.querySelector("#scoreTable tbody");
  const tr = document.createElement("tr");
  tr.innerHTML = `<td>${round}</td>`;

  players.forEach((_, i) => {
    tr.innerHTML += `<td><input type="number" id="score-${round}-${i}"></td>`;
  });

  let CaboHTML = `<td><select id="Cabo-${round}">
    <option value="">Select Cabo</option>`;
  players.forEach((p, i) => CaboHTML += `<option value="${i}">${p.name}</option>`);
  CaboHTML += `</select></td>`;

  tr.innerHTML += CaboHTML;
  tr.innerHTML += `<td id="round-total-${round}" class="total">-</td>`;
  tbody.appendChild(tr);

  saveGame();
}

/* ---------- REBUILD TABLE ---------- */
function rebuildTable() {
  const tbody = document.querySelector("#scoreTable tbody");
  tbody.innerHTML = "";

  rounds.forEach((r, idx) => {
    const rn = idx + 1;
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${rn}</td>`;

    players.forEach((_, i) => {
      const readonly = r.completed ? "readonly" : "";
      tr.innerHTML += `
        <td>
          <input type="number" ${readonly} value="${r.scores[i] ?? ""}" id="score-${rn}-${i}">
        </td>`;
    });

    tr.innerHTML += `<td>${r.completed ? players[r.CaboIndex]?.name ?? "-" : "-"}</td>`;
    tr.innerHTML += `<td class="total">${r.completed ? players.map(p => p.total).join(", ") : "-"}</td>`;
    tbody.appendChild(tr);
  });
}

/* ---------- INIT ---------- */
if (!store.currentGameId) newGame();
else loadGame(store.currentGameId);

refreshGameSelect();
</script>

</body>
</html>
